- name: Bootstrap the Ceph cluster on admin node
  hosts: admin
  become: true
  gather_facts: true

  tasks:
    - name: Get cluster interface IP address
      set_fact:
        cluster_ip: "{{ hostvars[inventory_hostname]['ansible_' + cluster_interface]['ipv4']['address'] }}"
        public_ip: "{{ hostvars[inventory_hostname]['ansible_' + public_interface]['ipv4']['address'] }}"

    - name: Bootstrap initial cluster
      ceph.automation.cephadm_bootstrap:
        mon_ip: "{{ public_ip }}"
        initial_dashboard_user: "{{ dashboard_user }}"
        initial_dashboard_password: "{{ dashboard_password }}"
        dashboard_password_noupdate: true
        allow_fqdn_hostname: true
        cluster_network: "{{ cluster_network }}"
        fsid: "{{ fsid }}"

    - name: Configure Public Network
      ceph.automation.ceph_config:
        who: global
        option: public_network
        value: "{{ public_network }}"

    - name: Enable ceph CLI access without podman digest pinning (optional)
      shell: cephadm shell -- ceph config set mgr mgr/cephadm/use_repo_digest false
      changed_when: false